name: ğŸš€ Deploy My Laravel Application

on: 
  push:
    branches:
      - master  # Remplacer par 'master' si nÃ©cessaire

jobs:
  deploy-laravel:
    name: ğŸ‰ Deploy My Laravel Application
    runs-on: ubuntu-latest

    steps:
    # Ã‰tape 1: Checkout du dernier code
    - name: ğŸšš Checkout the latest code
      uses: actions/checkout@v3

    # Ã‰tape 2: Configuration de PHP
    - name: ğŸ”§ Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # PHP 8.2 pour une version stable
        extensions: mbstring, exif, pcntl, bcmath, gd, pdo_mysql
        ini-values: post_max_size=128M, upload_max_filesize=128M, max_execution_time=180
        coverage: none

    # Ã‰tape 3: Installation des dÃ©pendances avec Composer
    - name: ğŸ§° Install dependencies via Composer
      run: composer install --prefer-dist --no-progress --no-suggest --optimize-autoloader --no-dev
      env:
        COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}

    # Ã‰tape 4: ExÃ©cution des commandes artisan (migrer, cache)
    - name: ğŸ› ï¸ Run Laravel artisan commands
      run: |
        php artisan migrate --force
        php artisan config:cache
        php artisan route:cache

    # Ã‰tape 5: Synchronisation des fichiers avec le serveur via FTP
    - name: ğŸ“‚ Sync files to the server
      uses: SamKirkland/FTP-Deploy-Action@4.0.0
      with:
        server: ${{ secrets.SERVER_NAME }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        server-dir: ${{ secrets.DEPLOY_PATH }}

    # Ã‰tape 6: Nettoyage des fichiers cache Laravel
    - name: ğŸ—‘ï¸ Cleanup old files (optional)
      run: php artisan optimize:clear

    # Ã‰tape 7: Fin du dÃ©ploiement
    - name: ğŸ‰ Complete deployment
      run: echo "Deployment finished successfully."
